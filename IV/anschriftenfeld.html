<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Übung Anschriftenfelder nach DIN 5008</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF zum Generieren von Zertifikaten -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Kleine Anpassung für die Lösungsanzeige */
        #solution-display {
            white-space: pre;
            line-height: 1.6;
        }
        textarea {
            white-space: pre;
            line-height: 1.6;
        }
        /* Verhindert Klick-Events, wenn der Button deaktiviert ist */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Container für den gesamten Prozess -->
    <div class="w-full max-w-lg">

        <!-- 1. Startbildschirm (zunächst sichtbar) -->
        <div id="start-screen" class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-blue-400 mb-6">
                Übung Anschriftenfelder
            </h1>
            <p class="text-center text-gray-300 mb-6">Bitte trage deinen Namen und deine Klasse ein, um zu starten. Diese Daten werden für dein Zertifikat benötigt.</p>
            
            <form id="start-form" class="space-y-4">
                <div>
                    <label for="studentNameInput" class="block text-sm font-medium text-gray-300 mb-2">Dein Name:</label>
                    <input type="text" id="studentNameInput" required 
                           class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-gray-300 font-medium text-sm sm:text-base focus:ring-2 focus:ring-blue-500 focus:outline-none" 
                           placeholder="z.B. Max Mustermann">
                </div>
                <div>
                    <label for="studentClassInput" class="block text-sm font-medium text-gray-300 mb-2">Deine Klasse:</label>
                    <input type="text" id="studentClassInput" required 
                           class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-gray-300 font-medium text-sm sm:text-base focus:ring-2 focus:ring-blue-500 focus:outline-none" 
                           placeholder="z.B. 10A">
                </div>
                <div class="pt-4">
                    <button type="submit" id="startButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg transition duration-200 shadow-lg">
                        Übung starten
                    </button>
                </div>
            </form>
            
            <!-- Copyright Footer -->
            <p class="text-center text-xs text-gray-600 mt-8">Copyright J. Mangold</p>

        </div>

        <!-- 2. App-Bildschirm (zunächst versteckt) -->
        <div id="app-screen" class="hidden bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl w-full">
            
            <!-- Titel -->
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-blue-400 mb-2">
                Übung Anschriftenfelder nach DIN 5008
            </h1>
            
            <!-- Punktestand -->
            <div class="text-center text-lg sm:text-xl font-bold text-gray-300 mb-6" id="scoreDisplay">
                Punkte: 0 / 20
            </div>

            <!-- Aufgaben-Sektion -->
            <div>
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">
                    Aufgabe:
                </h2>
                <p class="text-sm text-gray-400 mb-4">Fülle nur das Anschriftenfeld (nach DIN 5008) mit den Infos aus dem Aufgabentext:</p>
                <!-- Hier werden die Aufgabendetails per JS eingefügt -->
                <div id="task-details" class="bg-gray-700 p-4 rounded-lg space-y-2 text-gray-200">
                    <!-- Task text appears here -->
                </div>
            </div>
            
            <!-- Lösungs-Sektion (Jetzt Eingabe) -->
            <div class="mt-6">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">
                    Anschriftenfeld:
                </h2>
                <!-- Eingabefeld für den Schüler -->
                <textarea id="userInput" 
                          class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-gray-300 font-medium text-sm sm:text-base h-40 focus:ring-2 focus:ring-blue-500 focus:outline-none" 
                          placeholder="Tippe hier deine Lösung..."></textarea>
            </div>
            
            <!-- Feedback-Sektion -->
            <div id="feedback" class="mt-4 text-center font-medium text-lg">
                <!-- Feedback (z.B. "Richtig!" oder "Falsch!") wird hier per JS eingefügt -->
            </div>
            
            <!-- Container für die korrekte Lösung (wird bei Bedarf gezeigt) -->
            <div id="correct-solution-container" class="hidden mt-4">
                <h3 class="font-semibold text-gray-400">Korrekte Lösung:</h3>
                <div class="bg-gray-900 border border-green-700 rounded-lg p-4 mt-2">
                    <pre id="solution-display" class="text-green-300 font-medium text-sm sm:text-base"></pre>
                </div>
            </div>
            
            <!-- Steuerungs-Knöpfe -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button id="checkButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg transition duration-200 shadow-lg">
                    Lösung prüfen
                </button>
                <button id="newTaskButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg transition duration-200 shadow-lg">
                    Neue Aufgabe
                </button>
            </div>
            
            <!-- Zertifikat-Button (zunächst versteckt) -->
            <div class="pt-2">
                <button id="certButton" class="hidden w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-5 rounded-lg transition duration-200 shadow-lg">
                    Zertifikat herunterladen
                </button>
            </div>
            
            <!-- Copyright Footer -->
            <p class="text-center text-xs text-gray-600 mt-8">Copyright J. Mangold</p>
            
        </div>
    </div>

    <script>
        // --- DATENSPEICHER ---
        const anreden = ["Herrn", "Frau"];
        const vornamenM = ["Max", "Moritz", "Hans", "Peter", "Jürgen", "Michael", "Andreas", "Thomas", "Thorsten", "Udo"];
        const vornamenW = ["Anna", "Maria", "Lisa", "Sabine", "Petra", "Susanne", "Monika", "Claudia", "Margit", "Sonja"];
        const nachnamen = ["Müller", "Schmidt", "Schneider", "Fischer", "Weber", "Meyer", "Wagner", "Becker", "Schulz", "Stein", "Birkenfelder", "Meier", "Timm", "Maurer"];
        
        const firmenPraefixe = ["Bäckerei", "Handel", "Agentur", "Design", "Software", "Weinhandel", "Trampolino", "Hüpfburgen"];
        const firmenSuffixe = ["GmbH", "AG", "KG", "OHG", "e. K.", "GmbH & Co. KG", "Edeltropfen GmbH"];
        
        const strassen = ["Hauptstraße", "Goethestraße", "Schillerstraße", "Bahnhofstraße", "Musterweg", "Berliner Straße", "Ringstraße", "Schulstraße", "Nürnberger Str.", "Am Alten Schloss", "Landshuter Str.", "Tannenweg", "Alte Gasse"];
        const staedte = ["Berlin", "Hamburg", "München", "Köln", "Frankfurt", "Stuttgart", "Düsseldorf", "Leipzig", "Dortmund", "Essen", "Regensburg", "Coburg", "Starnberg", "Nürnberg"];

        // --- GLOBALE VARIABLEN ---
        let currentSolution = ""; // Speichert die korrekte Lösung für die aktuelle Aufgabe
        let score = 0; // Speichert den Punktestand
        let studentName = ""; // Wird beim Start gesetzt
        let studentClass = ""; // Wird beim Start gesetzt
        const maxScore = 20; // Ziel-Punktestand

        // --- DOM-Elemente ---
        // Startbildschirm
        const startScreenEl = document.getElementById('start-screen');
        const startFormEl = document.getElementById('start-form');
        const studentNameInputEl = document.getElementById('studentNameInput');
        const studentClassInputEl = document.getElementById('studentClassInput');
        
        // App-Bildschirm
        const appScreenEl = document.getElementById('app-screen');
        const scoreDisplayEl = document.getElementById('scoreDisplay');
        const taskDetailsEl = document.getElementById('task-details');
        const userInputEl = document.getElementById('userInput');
        const feedbackEl = document.getElementById('feedback');
        const correctSolutionContainerEl = document.getElementById('correct-solution-container');
        const solutionDisplayEl = document.getElementById('solution-display');
        
        // Buttons
        const checkButton = document.getElementById('checkButton');
        const newTaskButton = document.getElementById('newTaskButton');
        const certButton = document.getElementById('certButton');

        
        // --- KERNLOGIK ---

        /**
         * Startet die App nach Eingabe von Name und Klasse
         */
        function startApp(event) {
            event.preventDefault(); // Verhindert das Neuladen der Seite
            studentName = studentNameInputEl.value.trim();
            studentClass = studentClassInputEl.value.trim();
            
            if (studentName && studentClass) {
                startScreenEl.classList.add('hidden');
                appScreenEl.classList.remove('hidden');
                generateTask(); // Erste Aufgabe laden
            }
        }
        
        /**
         * Wählt ein zufälliges Element aus einem Array
         * @param {Array} arr Das Array
         * @returns {*} Ein zufälliges Element
         */
        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        /**
         * Mischt ein Array (Fisher-Yates-Algorithmus)
         * @param {Array} array Das zu mischende Array
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /**
         * Generiert eine zufällige 5-stellige PLZ
         */
        function generatePLZ() {
            return Math.floor(10000 + Math.random() * 90000).toString();
        }

        /**
         * Generiert eine zufällige Hausnummer (z.B. 17 oder 27 a)
         */
        function generateHausnummer() {
            const num = Math.floor(Math.random() * 150) + 1;
            if (Math.random() > 0.8) { // In 20% der Fälle mit Buchstabe
                const buchstabe = String.fromCharCode(97 + Math.floor(Math.random() * 5)); // a-e
                return `${num} ${buchstabe}`;
            }
            return num.toString();
        }

        /**
         * Aktualisiert die Anzeige des Punktestands
         */
        function updateScoreDisplay() {
            scoreDisplayEl.textContent = `Punkte: ${score.toFixed(0)} / ${maxScore}`;
            if (score >= maxScore && certButton.classList.contains('hidden')) {
                certButton.classList.remove('hidden');
                scoreDisplayEl.classList.add('text-green-400');
            }
        }
        
        /**
         * Zeigt den Aufgabentext (Fließtext) an
         */
        function displayTask(taskText) {
            taskDetailsEl.innerHTML = ''; // Vorherige Aufgabe löschen
            const p = document.createElement('p');
            p.textContent = taskText;
            taskDetailsEl.appendChild(p);
        }

        /**
         * Normalisiert einen mehrzeiligen String für den Vergleich (entfernt überflüssige Leerzeichen, etc.)
         * @param {string} str Der zu normalisierende String
         * @returns {string} Der normalisierte String
         */
        function normalizeString(str) {
            if (!str) return "";
            return str
                .trim() // Entfernt Leerzeichen am Anfang und Ende
                .toLowerCase() // Alles in Kleinbuchstaben
                .split('\n') // In Zeilen aufteilen
                .map(line => line.trim().replace(/\s+/g, ' ')) // Jede Zeile trimmen & interne Leerzeichen normalisieren
                .filter(line => line.length > 0) // Leere Zeilen entfernen
                .join('\n'); // Wieder zusammenfügen
        }

        /**
         * Normalisiert eine EINZELNE Zeile für den Vergleich.
         * @param {string} line Die zu normalisierende Zeile
         * @returns {string} Die normalisierte Zeile
         */
        function normalizeLine(line) {
            if (!line) return "";
            // Trimmen, Kleinbuchstaben, innere Leerzeichen normalisieren
            return line.trim().toLowerCase().replace(/\s+/g, ' ');
        }

        /**
         * Generiert eine neue Aufgabe und die dazugehörige Lösung.
         * NEU: Erstellt Textbausteine und mischt diese.
         */
        function generateTask() {
            // Reset
            userInputEl.value = "";
            feedbackEl.textContent = "";
            correctSolutionContainerEl.classList.add('hidden');
            checkButton.disabled = false;
            
            let solutionLines = [];
            let taskTextSnippets = []; // Array für gemischte Textbausteine
            
            const isCompany = Math.random() > 0.4; // 60% Firmen, 40% Privat

            // Zufällige Basisdaten
            const stadt = getRandomElement(staedte);
            const plz = generatePLZ();
            const strasse = getRandomElement(strassen);
            const hausnummer = generateHausnummer();
            
            // Logik für Anrede und Name
            const anrede = getRandomElement(anreden); // "Herrn" oder "Frau"
            const vorname = (anrede === "Herrn") ? getRandomElement(vornamenM) : getRandomElement(vornamenW);
            const nachname = getRandomElement(nachnamen);
            const vollerName = `${vorname} ${nachname}`;

            if (isCompany) {
                // --- FIRMENANSCHRIFT ---
                const firmaPraefix = getRandomElement(firmenPraefixe);
                const firmaSuffix = getRandomElement(firmenSuffixe);
                const firmenName = `${firmaPraefix} ${nachname} ${firmaSuffix}`;
                
                // Aufbau der LÖSUNG (korrekte Reihenfolge)
                solutionLines.push(firmenName);
                solutionLines.push(`${anrede} ${vollerName}`);
                solutionLines.push(`${strasse} ${hausnummer}`);
                solutionLines.push(`${plz} ${stadt}`);

                // Aufbau des AUFGABENTEXTS (Textbausteine für Mischen)
                // Grammatikalische Korrektur: "Herrn" (Lösung) vs. "Herr" (Aufgabentext)
                let anredeText = (anrede === "Herrn") ? "Herr" : "Frau";
                
                taskTextSnippets.push(`Du schreibst einen Brief an die Firma ${firmenName}.`);
                taskTextSnippets.push(`Als Ansprechpartner vor Ort ist ${anredeText} ${vollerName} zuständig.`);
                taskTextSnippets.push(`Die Postleitzahl des Unternehmens ist ${plz}.`);
                taskTextSnippets.push(`Du findest die Büros in ${stadt} unter der Adresse: ${strasse} ${hausnummer}.`);

            } else {
                // --- PRIVATANSCHRIFT ---
                
                // Aufbau der LÖSUNG (korrekte Reihenfolge)
                solutionLines.push(anrede);
                solutionLines.push(vollerName);
                solutionLines.push(`${strasse} ${hausnummer}`);
                solutionLines.push(`${plz} ${stadt}`);

                // Aufbau des AUFGABENTEXTS (Textbausteine für Mischen)
                taskTextSnippets.push(`Ein privater Brief soll an ${anrede} ${vollerName} gehen.`);
                taskTextSnippets.push(`Die Person wohnt in der ${strasse} ${hausnummer}.`);
                taskTextSnippets.push(`Der Wohnort ist ${stadt}.`);
                taskTextSnippets.push(`Die zugehörige Postleitzahl lautet ${plz}.`);
            }

            // --- Bausteine mischen und zu einem Text verbinden ---
            shuffleArray(taskTextSnippets);
            const taskText = taskTextSnippets.join(' '); // Zu einem Fließtext verbinden

            // Speichern und anzeigen
            currentSolution = solutionLines.join('\n');
            displayTask(taskText); // Übergibt den gemischten Fließtext
        }

        /**
         * Prüft die Eingabe des Benutzers, vergibt Teilpunkte und deaktiviert den Button.
         * NEU: Gibt spezifisches Feedback bei fehlendem Leerzeichen nach Punkt.
         */
        function checkSolution() {
            checkButton.disabled = true; // Button deaktivieren, um "farmen" zu verhindern
            
            let specificFeedback = ""; // Für den neuen Hinweis
            
            // Wir brauchen die rohen Zeilen für die Detail-Fehlersuche
            const userLinesRaw = userInputEl.value.trim().split('\n');
            const solutionLinesRaw = currentSolution.trim().split('\n');

            let correctLines = 0;
            const totalLines = solutionLinesRaw.length;

            for (let i = 0; i < totalLines; i++) {
                const userLine = userLinesRaw[i] || "";
                const solutionLine = solutionLinesRaw[i] || "";

                if (normalizeLine(userLine) === normalizeLine(solutionLine)) {
                    correctLines++;
                } else {
                    // Zeile ist falsch. Prüfen, ob es am fehlenden Leerzeichen nach Punkt liegt.
                    // Regex: Sucht nach einem Punkt (\.) gefolgt von einem Nicht-Leerzeichen (\S)
                    if (userLine.match(/\.\S/g)) {
                        specificFeedback = "Hinweis: Achte auf das Leerzeichen nach einem Punkt (z.B. bei 'Str.' oder 'e. K.').";
                    }
                }
            }
            
            const pointsEarned = correctLines; // GEÄNDERT: 1 Punkt pro Zeile
            score += pointsEarned;
            updateScoreDisplay();

            // Haupt-Feedback geben
            let primaryFeedback = "";
            if (correctLines === totalLines) {
                primaryFeedback = `Perfekt! ${correctLines} von ${totalLines} Zeilen richtig. (+${pointsEarned} Punkte)`;
                feedbackEl.className = 'mt-4 text-center font-medium text-lg text-green-400';
            } else {
                primaryFeedback = `Ergebnis: ${correctLines} von ${totalLines} Zeilen richtig. (+${pointsEarned} Punkte)`;
                feedbackEl.className = 'mt-4 text-center font-medium text-lg text-yellow-400';
            }

            // Spezifisches Feedback anhängen, falls vorhanden
            if (specificFeedback) {
                // Verwendet innerHTML, um einen Zeilenumbruch und andere Formatierung zu ermöglichen
                feedbackEl.innerHTML = `${primaryFeedback}<br><span class="text-sm text-cyan-400">${specificFeedback}</span>`;
            } else {
                feedbackEl.textContent = primaryFeedback;
            }
            
            // Immer die korrekte Lösung zum Vergleichen anzeigen
            solutionDisplayEl.textContent = currentSolution;
            correctSolutionContainerEl.classList.remove('hidden');
        }

        /**
         * Setzt die Oberfläche für eine neue Aufgabe zurück.
         */
        function prepareNewTask() {
            generateTask();
            checkButton.disabled = false;
        }

        /**
         * Generiert ein PDF-Zertifikat mit den Daten des Schülers.
         */
        function generateCertificate() {
            // Dynamisch jsPDF laden (falls es global verfügbar ist)
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const today = new Date();
            const dateStr = `${today.getDate()}.${today.getMonth() + 1}.${today.getFullYear()}`;

            // PDF-Inhalt
            doc.setFont("helvetica", "bold");
            doc.setFontSize(24);
            doc.setTextColor(40, 58, 122); // Tailwind blue-700
            doc.text("Zertifikat", 105, 40, { align: "center" });

            doc.setFont("helvetica", "normal");
            doc.setFontSize(16);
            doc.setTextColor(17, 24, 39); // Tailwind gray-900
            
            doc.text("Hiermit wird bestätigt, dass:", 105, 70, { align: "center" });
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.text(studentName, 105, 90, { align: "center" });
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(16);
            doc.text(`Klasse: ${studentClass}`, 105, 100, { align: "center" });

            doc.text("die Übung zu den Anschriftenfeldern", 105, 120, { align: "center" });
            doc.text("nach DIN 5008 erfolgreich", 105, 130, { align: "center" });
            doc.text("abgeschlossen hat.", 105, 140, { align: "center" });

            doc.setFontSize(14);
            doc.text(`Erreichte Punktzahl: ${score.toFixed(0)}`, 105, 160, { align: "center" });

            doc.setFontSize(12);
            doc.setTextColor(107, 114, 128); // Tailwind gray-500
            doc.text(`Ausgestellt am: ${dateStr}`, 105, 180, { align: "center" });
            
            doc.text("Copyright J. Mangold", 105, 200, { align: "center" });


            // Speichern
            doc.save(`Zertifikat-DIN5008-${studentName.replace(/ /g, '_')}.pdf`);
        }


        // --- EVENT LISTENERS ---
        startFormEl.addEventListener('submit', startApp);
        newTaskButton.addEventListener('click', prepareNewTask);
        checkButton.addEventListener('click', checkSolution);
        certButton.addEventListener('click', generateCertificate);

    </script>
</body>
</html>
